<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        #content {
            width: 560px;
            height: 400px;
            margin-left: auto;
            margin-right: auto;
            display: flex;
        }

        #stream {
            width: 280px;
            height: 280px;
        }

        #avatar {
            width: 280px;
            height: 280px;
        }

        video {
            width: 280px;
            margin-top: 30px;
        }

        #cameraSelect {
            width: 260px;
            margin-left: 10px;
            margin-top: 20px;
        }

        .title {
            width: 100%;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .subtitle {
            width: 100%;
            text-align: center;
            font-size: 16px;
            margin-bottom: 5px;
        }

        #change {
            width: 100%;
            margin-top: 20px;
        }

        #cameracontainer {
            width: 280px;
            height: 280px;
        }
    </style>
</head>

<body>
    <div class="title">Avatar Demo</div>
    <div class="subtitle">Look into the camera and talk</div>
    <div class="subtitle">Calibrate by closing your eyes and opening your mouth wide!</div>

    <div id="content">
        <div id="stream">
            <div id="videoandcontrols">
                <div id="cameracontainer">
                    <video id="camera"></video>
                </div>
                <select id="cameraSelect">
                </select>
            </div>
        </div>
        <div id="avatar">
            <div id="svg">
                <svg width="264px" height="280px" viewBox="0 0 264 280" version="1.1" xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink">
                    <desc></desc>
                    <defs>
                        <circle id="react-path-1" cx="120" cy="120" r="120"></circle>
                        <path
                            d="M12,160 C12,226.27417 65.72583,280 132,280 C198.27417,280 252,226.27417 252,160 L264,160 L264,-1.42108547e-14 L-3.19744231e-14,-1.42108547e-14 L-3.19744231e-14,160 L12,160 Z"
                            id="react-path-2"></path>
                        <path
                            d="M124,144.610951 L124,163 L128,163 L128,163 C167.764502,163 200,195.235498 200,235 L200,244 L0,244 L0,235 C-4.86974701e-15,195.235498 32.235498,163 72,163 L72,163 L76,163 L76,144.610951 C58.7626345,136.422372 46.3722246,119.687011 44.3051388,99.8812385 C38.4803105,99.0577866 34,94.0521096 34,88 L34,74 C34,68.0540074 38.3245733,63.1180731 44,62.1659169 L44,56 L44,56 C44,25.072054 69.072054,5.68137151e-15 100,0 L100,0 L100,0 C130.927946,-5.68137151e-15 156,25.072054 156,56 L156,62.1659169 C161.675427,63.1180731 166,68.0540074 166,74 L166,88 C166,94.0521096 161.51969,99.0577866 155.694861,99.8812385 C153.627775,119.687011 141.237365,136.422372 124,144.610951 Z"
                            id="react-path-3"></path>
                    </defs>
                    <g id="Avataaar" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <g transform="translate(-825.000000, -1100.000000)" id="Avataaar/Circle">
                            <g transform="translate(825.000000, 1100.000000)">
                                <g id="Mask"></g>
                                <g id="Avataaar" stroke-width="1" fill-rule="evenodd" mask="url(#react-mask-5)">
                                    <g id="Body" transform="translate(32.000000, 36.000000)">
                                        <mask id="react-mask-6" fill="white">
                                            <use xlink:href="#react-path-3"></use>
                                        </mask>
                                        <use fill="#D0C6AC" xlink:href="#react-path-3"></use>
                                        <g id="Skin/👶🏽-03-Brown" mask="url(#react-mask-6)" fill="#EDB98A">
                                            <g transform="translate(0.000000, 0.000000)" id="Color">
                                                <rect x="0" y="0" width="264" height="280"></rect>
                                            </g>
                                        </g>
                                        <path
                                            d="M156,79 L156,102 C156,132.927946 130.927946,158 100,158 C69.072054,158 44,132.927946 44,102 L44,79 L44,94 C44,124.927946 69.072054,150 100,150 C130.927946,150 156,124.927946 156,94 L156,79 Z"
                                            id="Neck-Shadow" fill-opacity="0.100000001" fill="#000000"
                                            mask="url(#react-mask-6)"></path>
                                    </g>
                                    <g id="Clothing/Shirt-Crew-Neck" transform="translate(0.000000, 170.000000)">
                                        <defs>
                                            <path
                                                d="M165.960472,29.2949161 C202.936473,32.3249982 232,63.2942856 232,101.051724 L232,110 L32,110 L32,101.051724 C32,62.9525631 61.591985,31.7649812 99.0454063,29.2195264 C99.0152598,29.5931145 99,29.9692272 99,30.3476251 C99,42.2107177 113.998461,51.8276544 132.5,51.8276544 C151.001539,51.8276544 166,42.2107177 166,30.3476251 C166,29.9946691 165.986723,29.6437014 165.960472,29.2949161 Z"
                                                id="react-path-175"></path>
                                        </defs>
                                        <mask id="react-mask-176" fill="white">
                                            <use xlink:href="#react-path-175"></use>
                                        </mask>
                                        <use id="Clothes" fill="#E6E6E6" fill-rule="evenodd"
                                            xlink:href="#react-path-175">
                                        </use>
                                        <g id="Color/Palette/Gray-01" mask="url(#react-mask-176)" fill-rule="evenodd"
                                            fill="#FF5C5C">
                                            <rect id="🖍Color" x="0" y="0" width="264" height="110"></rect>
                                        </g>
                                        <g id="Shadowy" opacity="0.599999964" stroke-width="1" fill-rule="evenodd"
                                            mask="url(#react-mask-176)" fill-opacity="0.16" fill="#000000">
                                            <g transform="translate(92.000000, 4.000000)" id="Hola-👋🏼">
                                                <ellipse cx="40.5" cy="27.8476251" rx="39.6351047" ry="26.9138272">
                                                </ellipse>
                                            </g>
                                        </g>
                                    </g>
                                    <g id="Face" transform="translate(76.000000, 82.000000)" fill="#000000">
                                        <g id="Mouth/Smile" transform="translate(2.000000, 52.000000)">
                                            <defs>
                                                <path
                                                    d="M35.117844,15.1280772 C36.1757121,24.6198025 44.2259873,32 54,32 C63.8042055,32 71.8740075,24.574136 72.8917593,15.0400546 C72.9736685,14.272746 72.1167429,13 71.042767,13 C56.1487536,13 44.7379213,13 37.0868244,13 C36.0066168,13 35.0120058,14.1784435 35.117844,15.1280772 Z"
                                                    id="react-path-179"></path>
                                            </defs>
                                            <mask id="react-mask-180" fill="white">
                                                <use xlink:href="#react-path-179"></use>
                                            </mask>
                                            <use id="Mouth" fill-opacity="0.699999988" fill="#000000"
                                                fill-rule="evenodd" xlink:href="#react-path-179"></use>
                                            <rect id="Teeth" fill="#FFFFFF" fill-rule="evenodd"
                                                mask="url(#react-mask-180)" x="39" y="2" width="31" height="16" rx="5">
                                            </rect>
                                            <g id="Tongue" stroke-width="1" fill-rule="evenodd"
                                                mask="url(#react-mask-180)" fill="#FF4F6D">
                                                <g transform="translate(38.000000, 24.000000)">
                                                    <circle cx="11" cy="11" r="11"></circle>
                                                    <circle cx="21" cy="11" r="11"></circle>
                                                </g>
                                            </g>
                                        </g>
                                        <g id="Nose/Default" transform="translate(28.000000, 40.000000)"
                                            fill-opacity="0.16">
                                            <path
                                                d="M16,8 C16,12.418278 21.372583,16 28,16 L28,16 C34.627417,16 40,12.418278 40,8"
                                                id="Nose"></path>
                                        </g>
                                        <g id="Eyes/Default-😀" transform="translate(0.000000, 8.000000)"
                                            fill-opacity="0.599999964">
                                            <circle id="Eye" cx="30" cy="22" r="6"></circle>
                                            <circle id="Eye" cx="82" cy="22" r="6"></circle>
                                        </g>
                                        <g id="Eyebrow/Outline/Default" fill-opacity="0.599999964">
                                            <g id="I-Browse" transform="translate(12.000000, 6.000000)">
                                                <path
                                                    d="M3.63024536,11.1585767 C7.54515501,5.64986673 18.2779197,2.56083721 27.5230268,4.83118046 C28.5957248,5.0946055 29.6788665,4.43856013 29.9422916,3.36586212 C30.2057166,2.2931641 29.5496712,1.21002236 28.4769732,0.94659732 C17.7403633,-1.69001789 5.31209962,1.88699832 0.369754639,8.84142326 C-0.270109626,9.74178291 -0.0589363917,10.9903811 0.84142326,11.6302454 C1.74178291,12.2701096 2.9903811,12.0589364 3.63024536,11.1585767 Z"
                                                    id="Eyebrow" fill-rule="nonzero"></path>
                                                <path
                                                    d="M61.6302454,11.1585767 C65.545155,5.64986673 76.2779197,2.56083721 85.5230268,4.83118046 C86.5957248,5.0946055 87.6788665,4.43856013 87.9422916,3.36586212 C88.2057166,2.2931641 87.5496712,1.21002236 86.4769732,0.94659732 C75.7403633,-1.69001789 63.3120996,1.88699832 58.3697546,8.84142326 C57.7298904,9.74178291 57.9410636,10.9903811 58.8414233,11.6302454 C59.7417829,12.2701096 60.9903811,12.0589364 61.6302454,11.1585767 Z"
                                                    id="Eyebrow" fill-rule="nonzero"
                                                    transform="translate(73.000154, 6.039198) scale(-1, 1) translate(-73.000154, -6.039198) ">
                                                </path>
                                            </g>
                                        </g>
                                    </g>
                                    <g id="Top" stroke-width="1" fill-rule="evenodd">
                                        <defs>
                                            <rect id="react-path-161" x="0" y="0" width="264" height="280"></rect>
                                            <path
                                                d="M65.1802189,77.7372986 C67.3631845,76.1045334 80.4065113,75.4786511 82.757829,74.0894494 C83.4916461,73.6553857 84.0610723,73.215719 84.4997781,72.7800074 C84.938814,73.215719 85.5085703,73.6553857 86.2423874,74.0894494 C88.593375,75.4786511 101.636702,76.1045334 103.819667,77.7372986 C106.030032,79.3908276 107.643571,83.1846831 107.466966,86.15095 C107.255041,89.7101408 103.361486,98.2028927 93.6723269,99.1811016 C91.5576925,96.8281927 88.2368647,95.3104528 84.4997781,95.3104528 C80.7633517,95.3104528 77.4421938,96.8281927 75.3275594,99.1811016 C65.6387308,98.2028927 61.7451757,89.7101408 61.5332501,86.15095 C61.3566455,83.1846831 62.9701849,79.3908276 65.1802189,77.7372986 M103.141638,94.9063813 C103.142958,94.9057221 103.144609,94.905063 103.145929,94.9047334 C103.144278,94.905063 103.142958,94.9057221 103.141638,94.9063813 M65.8453747,94.9014375 C65.8493359,94.9030855 65.8565982,94.9057221 65.8618798,94.9076997 C65.8565982,94.9057221 65.8509864,94.9034151 65.8453747,94.9014375 M144.86259,55.9853335 C144.47439,50.0303878 143.277769,44.1519058 142.233986,38.2862777 C141.952739,36.7072349 140.423706,26 139.734783,26 C139.502391,35.1094058 138.701893,44.0803858 137.669664,53.1393651 C137.361018,55.8475668 137.037848,58.5564277 136.825262,61.2741874 C136.653609,63.4695546 136.959614,66.1220564 136.427819,68.2455739 C135.749129,70.9524573 132.348087,73.4783984 129.702978,74.410795 C123.102915,76.7373371 117.597802,67.1077689 111.960977,64.2911336 C104.643272,60.6347152 92.0637391,59.7639895 84.5816434,64.5297918 C76.9361472,59.7639895 64.356614,60.6347152 57.0389092,64.2911336 C51.4024147,67.1077689 45.8969708,76.7373371 39.2972383,74.410795 C36.6521296,73.4783984 33.2504268,70.9524573 32.572397,68.2455739 C32.0402723,66.1220564 32.346277,63.4695546 32.174954,61.2741874 C31.9623682,58.5564277 31.6388681,55.8475668 31.3302226,53.1393651 C30.2983232,44.0803858 29.4974953,35.1094058 29.2654335,26 C28.5761802,26 27.0468169,36.7072349 26.7658999,38.2862777 C25.7221169,44.1519058 24.5258266,50.0303878 24.1376265,55.9853335 C23.738533,62.1047422 24.2148704,68.1674622 25.4695887,74.1632765 C26.0687242,77.0277016 26.7685407,79.8756475 27.518863,82.7041478 C28.352701,85.8467429 27.198994,91.9661516 27.5723395,95.1921317 C28.2787581,101.29572 31.1542781,113.199679 34.3833375,118.45096 C35.9440605,120.989096 37.7734867,122.573742 39.816489,124.619148 C41.7825775,126.58809 42.6038717,129.640049 44.7260985,131.73687 C48.6820428,135.645092 54.4456266,137.971304 60.3656788,138.543134 C65.6773527,143.050212 74.505605,146 84.4997781,146 C94.4946114,146 103.322534,143.050212 108.634538,138.543134 C114.55393,137.971304 120.317843,135.645092 124.274118,131.73687 C126.396015,129.640049 127.217309,126.58809 129.183727,124.619148 C131.2264,122.573742 133.055826,120.989096 134.616879,118.45096 C137.845608,113.199679 140.721458,101.29572 141.427547,95.1921317 C141.800892,91.9661516 140.647185,85.8467429 141.481353,82.7041478 C142.231676,79.8756475 142.931162,77.0277016 143.530628,74.1632765 C144.784686,68.1674622 145.261353,62.1047422 144.86259,55.9853335 Z"
                                                id="react-path-162"></path>
                                            <path
                                                d="M185.831676,73.928751 C187.588868,74.9173665 188.980206,84.8279256 189.047535,88.6176558 C189.08965,90.9562115 189.127358,99.8740101 186.654049,99.1031293 C185.901013,98.868423 184.751682,94.1472484 184.58821,91.3840965 C184.424737,88.6209446 182.855069,79.2200034 180.446757,74.8947261 C179.896491,73.9063366 178.320781,72.1708928 179.001547,71.3348066 C179.846064,70.2980597 180.666198,70.8995898 181.697184,71.3146953 C182.8124,71.7641482 185.6344,73.8180261 185.831676,73.928751 Z M186.636742,70.9565876 C185.890663,71.9188016 180.795829,69.217693 178.671174,68.0439722 C160.825581,58.1840558 157.361562,55.0486831 129.245707,55.4578453 C101.129853,55.8670074 81.8674779,69.0400225 80.7839818,70.3874406 C80.0301584,71.3248831 79.0677773,73.8279219 78.2764086,80.8005402 C77.48504,87.7731584 78.4952061,100.277789 75.6304859,100.262618 C73.1915094,100.249702 72.6608912,76.4770353 73.7137309,67.0463924 C73.8753757,65.5984852 74.4983655,63.0083957 74.0474223,61.7058802 C73.6532986,60.5682485 71.7253768,60.5705662 72.0331217,58.6750651 C72.3829065,56.5173393 74.5584694,57.5890837 75.5060085,56.5574014 C77.3005851,54.602966 74.5321945,54.1404306 74.0730403,52.4306721 C73.3905494,49.8892108 75.3628102,49.2336489 77.1396512,48.4310821 C79.1060001,47.5437559 78.8504766,48.3231462 80.4463492,46.5849138 C78.3147968,45.0224912 77.543628,42.8939014 80.4624425,41.7519655 C81.7019616,41.2669159 84.9268789,41.9089031 85.8980654,41.1801698 C86.1512899,40.9901231 86.251463,39.9008308 86.4074703,39.6780059 C87.9583471,37.4593592 87.5757186,35.8532324 87.4183976,33.3624282 C87.2889936,31.3242265 87.3064008,29.4532263 89.7466834,29.2496048 C91.3750712,29.1138571 92.6993269,30.4441843 94.1582415,30.835866 C95.7767762,31.2705896 95.1688403,31.5877757 96.4369334,30.7150174 C98.6630755,29.1817309 97.1479982,26.1942888 98.913344,24.4120212 C101.335891,21.9662454 102.923881,25.5513084 104.868882,25.8218105 C109.09126,26.4101607 107.736132,22.1218586 110.235861,20.5504965 C113.223647,18.6738677 113.512672,22.8012592 115.378847,22.948264 C116.996068,23.0750722 119.907657,19.9545311 121.317306,19.3731338 C125.499944,17.6471518 127.572378,22.5039387 131.554013,21.8844657 C134.443268,21.434843 135.223305,21.067662 137.830761,22.7115333 C140.361692,24.3070651 140.96306,23.1664535 143.828996,23.1436082 C145.853806,23.128378 147.093982,24.8202575 148.787729,24.9967295 C149.632467,25.085131 150.441078,24.2050888 151.347562,24.2603811 C154.58496,24.4567186 154.789576,28.6430444 157.361562,29.7955753 C159.711524,30.8487786 162.474332,29.3691289 164.806559,29.0953159 C170.497048,28.4275036 166.60015,33.7425217 166.760755,36.914713 C168.994451,37.4358517 171.261648,35.3509661 173.485163,35.7347015 C176.986623,36.3392753 175.664995,39.9680424 174.853429,42.4144804 C177.279589,42.3707762 183.612828,39.6776748 185.184725,43.1220237 C185.995306,44.8980006 184.106797,47.2689496 184.13767,49.0743937 C184.181023,51.615855 186.048513,53.7186196 186.709327,56.1240021 C187.601032,59.3710203 188.871834,68.0740038 186.636742,70.9565876 Z"
                                                id="react-path-163"></path>
                                        </defs>
                                        <mask id="react-mask-160" fill="white">
                                            <use xlink:href="#react-path-161"></use>
                                        </mask>
                                        <g id="Mask"></g>
                                        <g id="Top/Short-Hair/Dreads-01" mask="url(#react-mask-160)">
                                            <g transform="translate(-1.000000, 0.000000)">
                                                <g id="Hair" stroke-width="1" fill-rule="evenodd"
                                                    transform="translate(1.000000, 0.000000)">
                                                    <mask id="react-mask-159" fill="white">
                                                        <use xlink:href="#react-path-163"></use>
                                                    </mask>
                                                    <use id="Dreads-With-Cut" fill="#2E3257"
                                                        xlink:href="#react-path-163">
                                                    </use>
                                                    <g id="Skin/👶🏽-03-Brown" mask="url(#react-mask-159)"
                                                        fill="#B58143">
                                                        <g transform="translate(0.000000, 0.000000) " id="Color">
                                                            <rect x="0" y="0" width="264" height="280"></rect>
                                                        </g>
                                                    </g>
                                                </g>
                                            </g>
                                        </g>
                                    </g>
                                </g>
                            </g>
                        </g>
                    </g>
                </svg>
            </div>
            <button id="change">Change</button>
        </div>
    </div>
    <div class="subtitle">Create an Avatar at <a href="https://getavataaars.com/">GetAvataaars!</a></div>
    <div class="subtitle">The avatar must be created with eyes = <code>Default</code> eyes and mouth =
        <code>Smile</code></a></div>
    <script>
        function copyFrame() {
            faceMesh.send({ image: video });
            video.requestVideoFrameCallback(copyFrame);
        }

        function handleEnumError(e) {
            console.log(e);
        }

        function gotDevices(deviceInfos) {
            // Handles being called several times to update labels. Preserve values.
            const values = selectors.map(select => select.value);
            selectors.forEach(select => {
                while (select.firstChild) {
                    select.removeChild(select.firstChild);
                }
            });

            let option;

            for (let i = 0; i !== deviceInfos.length; ++i) {
                const deviceInfo = deviceInfos[i];
                option = document.createElement('option');
                option.value = deviceInfo.deviceId;
                if (deviceInfo.kind === 'videoinput') {
                    option.text = deviceInfo.label || `camera ${videoSelect.length + 1}`;
                    videoSelect.appendChild(option);
                }
            }
            selectors.forEach((select, selectorIndex) => {
                if (Array.prototype.slice.call(select.childNodes).some(n => n.value === values[selectorIndex])) {
                    select.value = values[selectorIndex];
                }
            });
        }

        function findMinMaxAverage(landmarks, indicies) {
            const result = {
                averageX: 0,
                averageY: 0,
                minY: undefined,
                maxY: undefined
            };
            for (const ptIndex of indicies) {
                const pt = landmarks[ptIndex[0]];
                const x = pt.x;
                const y = pt.y;
                result.x += pt.x;
                result.y += pt.y;
                if ((result.minY === undefined) || (result.minY > y)) {
                    result.minY = y;
                }
                if ((result.maxY === undefined) || (result.maxY < y)) {
                    result.maxY = y;
                }
            }
            result.x /= indicies.length;
            result.y /= indicies.length;

            return result;
        }

        function onResults(results) {
            let rightEyeX = 0;
            let rightEyeY = 0;
            let leftEyeX = 0;
            let leftEyeY = 0;
            let centerX = 0;
            let centerY = 0;
            let mouthX = 0;
            let mouthY = 0;
            let mouthMinY = 0;
            let mouthMaxY = 0;
            let faceMinY = 0;
            let faceMaxY = 0;

            let eyeMinY = 0;
            let eyeMaxY = 0;
            let eyeSize = 0;

            let leftEyeStats;
            let rightEyeStats;
            let faceStats;
            let mouthStats;

            if (results.multiFaceLandmarks) {
                for (const landmarks of results.multiFaceLandmarks) {
                    leftEyeStats = findMinMaxAverage(landmarks, FACEMESH_LEFT_EYE);
                    rightEyeStats = findMinMaxAverage(landmarks, FACEMESH_RIGHT_EYE);
                    faceStats = findMinMaxAverage(landmarks, FACEMESH_FACE_OVAL);
                    mouthStats = findMinMaxAverage(landmarks, FACEMESH_LIPS);

                    const faceHeight = faceStats.maxY - faceStats.minY;
                    const mouthHeight = (mouthStats.maxY - mouthStats.minY) / faceHeight;
                    const leftEyeHeight = (leftEyeStats.maxY - leftEyeStats.minY) / faceHeight;
                    const rightEyeHeight = (rightEyeStats.maxY - rightEyeStats.minY) / faceHeight;

                    if ((mouthRange.min === undefined) || (mouthRange.min > mouthHeight)) {
                        mouthRange.min = mouthHeight;
                    }
                    if ((mouthRange.max === undefined) || (mouthRange.max < mouthHeight)) {
                        mouthRange.max = mouthHeight;
                    }
                    if ((leftEyeRange.min === undefined) || (leftEyeRange.min > leftEyeHeight)) {
                        leftEyeRange.min = leftEyeHeight;
                    }
                    if ((leftEyeRange.max === undefined) || (leftEyeRange.max < leftEyeHeight)) {
                        leftEyeRange.max = leftEyeHeight;
                    }
                    if ((rightEyeRange.min === undefined) || (rightEyeRange.min > rightEyeHeight)) {
                        rightEyeRange.min = rightEyeHeight;
                    }
                    if ((rightEyeRange.max === undefined) || (rightEyeRange.max < rightEyeHeight)) {
                        rightEyeRange.max = rightEyeHeight;
                    }

                    let mouthOpenPer = (mouthHeight - mouthRange.min) / (mouthRange.max - mouthRange.min);
                    if (mouthOpenPer < 0.1) {
                        mouthOpenPer = 0.1;
                    }
                    let leftEyePer = (leftEyeHeight - leftEyeRange.min) / (leftEyeRange.max - leftEyeRange.min);
                    if (leftEyePer < 0.2) {
                        leftEyePer = 0.2;
                    }
                    if (leftEyePer > 0.2) {
                        leftEyePer = 1;
                    }
                    let rightEyePer = (rightEyeHeight - rightEyeRange.min) / (rightEyeRange.max - rightEyeRange.min);
                    if (rightEyePer < 0.2) {
                        rightEyePer = 0.2;
                    }
                    if (rightEyePer > 0.2) {
                        rightEyePer = 1;
                    }

                    TweenMax.to(mouthBig, 0.05, { scaleY: Math.min(1.5, 0.2 + (mouthOpenPer * 2)) });
                    TweenMax.to(leftEye, 0.05, { scaleY: leftEyePer });
                    TweenMax.to(rightEye, 0.05, { scaleY: rightEyePer });

                    // only process first face
                    break;
                }
            }
        }

        function processAvatar() {
            mouthBig = document.getElementById('Mouth/Smile');
            teeth = document.getElementById('Teeth');
            tongue = document.getElementById('Tongue');
            teeth.parentElement.removeChild(teeth);
            tongue.parentElement.removeChild(tongue);

            eyes = document.getElementById("Eyes/Default-😀");
            leftEye = eyes.getElementsByTagName("circle").item(0);
            rightEye = eyes.getElementsByTagName("circle").item(1);

            brows = document.getElementById("I-Browse");
            leftBrow = eyes.getElementsByTagName("path").item(0);
            rightBrow = eyes.getElementsByTagName("path").item(1);
        }

        function changeAvatar() {
            let input = document.createElement('input');
            input.type = 'file';

            input.onchange = e => {
                let file = e.target.files[0];

                // setting up the reader
                let reader = new FileReader();
                reader.readAsText(file, 'UTF-8');

                // here we tell the reader what to do when it's done reading...
                reader.onload = readerEvent => {
                    var content = readerEvent.target.result; // this is the content!
                    document.getElementById("svg").innerHTML = content;
                    processAvatar();
                }
            }

            input.click();
        }

        function getMedia() {
            const sourceId = videoSelect.value;

            if (videoStream) {
                videoStream.getTracks().forEach(track => {
                    track.stop();
                });
            }

            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({
                    video: { deviceId: sourceId ? { exact: sourceId } : undefined },
                }).then(function (stream) {
                    video.srcObject = stream;
                    videoStream = stream;
                    if (!faceMesh) {
                        faceMesh = new FaceMesh({
                            locateFile: (file) => {
                                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                            }
                        });
                        faceMesh.setOptions({
                            maxNumFaces: 1,
                            refineLandmarks: true,
                            minDetectionConfidence: 0.5,
                            minTrackingConfidence: 0.5
                        });
                        faceMesh.onResults(onResults);
                        video.requestVideoFrameCallback(copyFrame);
                    }
                }).catch(function (e) {
                    console.log("Something went wrong!");
                });
            }
        }

        // these ranges are as percentage of the height of the face
        let mouthRange = {
            min: 0.1,
            max: 0.3
        };
        let leftEyeRange = {
            min: 0.3,
            max: 0.05
        };
        let rightEyeRange = {
            min: 0.3,
            max: 0.05
        }

        let mouthBig;
        let teeth;
        let tongue;
        let eyes;
        let leftEye;
        let rightEye;
        let brows;
        let leftBrow;
        let rightBrow;
        let lastEyeClose = 0;
        let video;
        let faceMesh;
        let avatar;
        let svg;
        let changeButton;
        let videoSelect;
        let videoStream;

        avatar = document.getElementById("avatar");
        svg = document.getElementById("svg");
        video = document.getElementById("camera");
        changeButton = document.getElementById("change");
        videoSelect = document.getElementById("cameraSelect");
        const selectors = [videoSelect];

        processAvatar();

        svg.addEventListener("click", () => {
            changeAvatar();
        });
        changeButton.addEventListener("click", () => {
            changeAvatar();
        });

        video.autoplay = true;

        getMedia();

        navigator.mediaDevices.enumerateDevices().then(gotDevices).catch(handleEnumError);
        videoSelect.onchange = getMedia;
    </script>
</body>

</html>